<%
ENV["REGION"] = "eu-west-1"
%>
---
  driver:
    name: ec2
    region: eu-west-1
    instance_type: t2.xlarge
    shared_credentials_profile: <%= ENV['AWS_PROFILE'] %>
    iam_profile_name: sm-access-profile
    tags:
      X-Contact: <%= ENV['USER'] %>
      X-Application: "Test-Kitchen"
      X-Customer: "Test-Kitchen"
      X-Project: "Test-Kitchen"
      X-TTL: '4'

  lifecycle:
    pre_create:
    - echo $REGION
    - aws secretsmanager create-secret --region $REGION --name test-secret --secret-string test1234
    - aws iam create-role --role-name secrets_role --assume-role-policy-document file://ec2-role-trust-policy.json
    - aws iam put-role-policy --role-name secrets_role --policy-name SM-Permissions --policy-document file://ec2-role-access-policy.json
    - aws iam create-instance-profile --instance-profile-name sm-access-profile
    - aws iam add-role-to-instance-profile --instance-profile-name sm-access-profile --role-name secrets_role
    - sleep 10

    post_create:
    - remote: sudo apt update && sudo apt install -y build-essential

    post_destroy:
    - aws secretsmanager delete-secret --region $REGION --secret-id test-secret --force-delete-without-recovery
    - aws iam delete-role-policy --role-name secrets_role --policy-name SM-Permissions
    - aws iam remove-role-from-instance-profile --instance-profile-name sm-access-profile --role-name secrets_role
    - aws iam delete-instance-profile --instance-profile-name sm-access-profile
    - aws iam delete-role --role-name secrets_role
    - sleep 10

  transport:
    ssh_key: ~/.ssh/<%= ENV["AWS_SSH_KEY_ID"] %>

  platforms:
    - name: ubuntu-18.04
      provisioner:
        named_run_list: aws
      attributes:
        secrets_test:
          region: <%= ENV["REGION"] %>
