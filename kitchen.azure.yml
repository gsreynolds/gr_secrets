<%
ENV["VAULTNAME"] = "#{ENV['USER']}-vault"
ENV["LOCATION"] = "northeurope"
ENV["RGNAME"] = "kitchen-#{ENV['USER']}-secrets"
%>
---
  driver:
    name: azurerm
    explicit_resource_group_name: kitchen-<%= ENV['USER'] %>-secrets
    vm_tags:
      X-Contact: <%= ENV['USER'] %>
      X-Application: "Test-Kitchen"
      X-Customer: "Test-Kitchen"
      X-Project: "Test-Kitchen"
      X-TTL: "4"

  lifecycle:
    pre_create:
      - echo $RGNAME
      - echo $LOCATION
      - echo $VAULTNAME
      - az group create -n $RGNAME -l $LOCATION
      - az provider register -n Microsoft.KeyVault
      - az keyvault create --name $VAULTNAME --resource-group $RGNAME --location $LOCATION
      - az keyvault secret set --vault-name $VAULTNAME --name "test-secret" --value "test1234"
    post_create:
      - az keyvault set-policy --name $VAULTNAME --resource-group $RGNAME --secret-permissions get list --object-id $(az vm identity show -g $RGNAME -n xenial-vm | jq -r '.principalId')
  
  driver_config:
    subscription_id: <%= ENV["AZURE_SUBSCRIPTION_ID"] %>
    location: 'North Europe'
    machine_size: 'Standard_D2s_v3'
  
  transport:
    ssh_key: <%= ENV["SSH_KEY"] %>
  
  platforms:
    - name: az-ubuntu-18.04
      attributes:
        secrets_test:
          vault: <%= ENV["VAULTNAME"] %>
      driver:
        image_urn: Canonical:UbuntuServer:18.04-LTS:latest
        system_assigned_identity: true
        vm_name: xenial-vm
        vm_tags:
          ostype: linux
          distro: ubuntu
